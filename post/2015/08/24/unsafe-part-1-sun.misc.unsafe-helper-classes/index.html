<!DOCTYPE html><html lang=en><head><meta charset=utf-8><title>Unsafe Part 1: sun.misc.Unsafe Helper Classes</title><meta name=description content="I recently came across the sun.misc.Unsafe class, a poorly documented, internal API that gives your java program direct access to the JVM’s memory. Of course accessing the JVM’s memory can be considered unsafe, but allows for some exciting opportunities. You can use Unsafe to inspect and manipulate the layout of your objects in RAM, allocate memory off the heap, do interesting things with threads, or even hack in multiple inheritance. Multiple people have written about Unsafe before, and there are some really good articles, so we won’t cover it here."><meta name=author content="Andrew Brampton"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo"/><link rel=canonical href="https://blog.bramp.net/post/2015/08/24/unsafe-part-1-sun.misc.unsafe-helper-classes/"/><link rel="shortcut icon" href=/favicon.ico type="image/x-icon"/><link rel=apple-touch-icon-precomposed href="/images/favicon.png"/><link rel=apple-touch-icon-precomposed sizes=57x57 href="/images/favicon-57x57.png"/><link rel=apple-touch-icon-precomposed sizes=72x72 href="/images/favicon-72x72.png"/><link rel=apple-touch-icon-precomposed sizes=76x76 href="/images/favicon-76x76.png"/><link rel=apple-touch-icon-precomposed sizes=114x114 href="/images/favicon-114x114.png"/><link rel=apple-touch-icon-precomposed sizes=120x120 href="/images/favicon-120x120.png"/><link rel=apple-touch-icon-precomposed sizes=144x144 href="/images/favicon-144x144.png"/><link rel=apple-touch-icon-precomposed sizes=152x152 href="/images/favicon-152x152.png"/><link rel=apple-touch-icon-precomposed sizes=180x180 href="/images/favicon-180x180.png"/><meta name=msapplication-TileColor content=#4582EC><meta name=msapplication-TileImage content=/images/favicon-144x144.png><meta name=theme-color content=#4582EC><link rel=icon sizes=192x192 href="/images/favicon-192x192.png"/><link href=/css/all.min.css rel=stylesheet><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel=stylesheet type=text/css><link href=https://netdna.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/font-hack/2.010/css/hack.min.css><meta name=twitter:card content="summary"/><meta name=twitter:site content="@TheBramp"/><meta name=twitter:title content="Unsafe Part 1: sun.misc.Unsafe Helper Classes"/><meta name=twitter:url content="https://blog.bramp.net/post/2015/08/24/unsafe-part-1-sun.misc.unsafe-helper-classes/"/><meta name=twitter:creator content="@TheBramp"/><meta name=twitter:description content="I recently came across the sun.misc.Unsafe class, a poorly documented, internal API that gives your java program direct access to the JVM’s memory. Of course accessing the JVM’s memory can be considered unsafe, but allows for some exciting opportunities. You can use Unsafe to inspect and manipulate the layout of your objects in RAM, allocate memory off the heap, do interesting things with threads, or even hack in multiple inheritance. Multiple people have written about Unsafe before, and there are some really good articles, so we won’t cover it here."/><meta property=og:type content="article"/><meta property=article:author content="https://www.facebook.com/bramp"/><meta property=article:published_time content="2015-08-24T20:13:58&#43;07:00"/><meta property=article:tag content="unsafe"/><meta property=article:tag content="java"/><meta property=og:url content="https://blog.bramp.net/post/2015/08/24/unsafe-part-1-sun.misc.unsafe-helper-classes/"/><meta property=og:site_name content="bramp.net"/><meta property=og:title content="Unsafe Part 1: sun.misc.Unsafe Helper Classes"/><meta property=og:description content="I recently came across the sun.misc.Unsafe class, a poorly documented, internal API that gives your java program direct access to the JVM’s memory. Of course accessing the JVM’s memory can be considered unsafe, but allows for some exciting opportunities. You can use Unsafe to inspect and manipulate the layout of your objects in RAM, allocate memory off the heap, do interesting things with threads, or even hack in multiple inheritance. Multiple people have written about Unsafe before, and there are some really good articles, so we won’t cover it here."/><meta property=og:updated_time content="2015-08-24T20:13:58-07:00"/><meta property=og:locale content="en_GB"/><meta name=google-site-verification content="RXqIC-7spNUYReoHFlubz8Fbqsg1fC1pE6FSgSnCNjQ"/><script type=text/javascript>!function(a,b,c,d,e,f,g){a.RaygunObject=e,a[e]=a[e]||function(){
    (a[e].o=a[e].o||[]).push(arguments)},f=b.createElement(c),g=b.getElementsByTagName(c)[0],
    f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","//cdn.raygun.io/raygun4js/raygun.min.js","rg4js");</script><body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-136478-5', 'auto');
    ga('require', 'linkid', 'linkid.js');
    ga('send', 'pageview');</script><div id=wrapper><div class="navbar navbar-default"><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button><div class=navbar-brand aria-label="About Andrew Brampton"><a href="/"><img src=/images/favicon-64x64.png class=profile-image alt=Home></a><div><a href="/about-me/">Andrew Brampton</a><div id=social-wrapper><a href=https://twitter.com/TheBramp aria-label=Twitter><i class="fa fa-twitter-square"></i></a> <a href=https://www.linkedin.com/in/bramp aria-label=LinkedIn><i class="fa fa-linkedin-square"></i></a> <a href=https://www.facebook.com/bramp aria-label=Facebook><i class="fa fa-facebook-square"></i></a> <a href=https://github.com/bramp aria-label=GitHub><i class="fa fa-github-square"></i></a> <a href=https://feeds.feedburner.com/brampnet aria-label="RSS feed"><i class="fa fa-rss-square"></i></a></div></div></div></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav" role=navigation><li><a href="/">Articles</a></li><li><a href="/about-me/">About Me</a></li><li><a href="/android-app/">Android Apps</a></li><li><a href="/opensource-project/">Open Source</a></li><li><a href="/publication/">Publications</a></li></ul></div></div></div><div class="container main"><div id=article><h1>Unsafe Part 1: sun.misc.Unsafe Helper Classes</h1><p class=meta><i class="fa fa-calendar-o"></i> 2015-08-24 | <a href="https://blog.bramp.net/tags/unsafe/">unsafe</a> | <a href="https://blog.bramp.net/tags/java/">java</a></p><div class=post><p>I recently came across the <a href=http://www.docjar.com/docs/api/sun/misc/Unsafe.html>sun.misc.Unsafe class</a>, a poorly documented, internal API that gives your java program direct access to the JVM’s memory. Of course accessing the JVM’s memory can be considered unsafe, but allows for some exciting opportunities.</p><p>You can use Unsafe to inspect and manipulate the layout of your objects in RAM, allocate memory off the heap, do interesting things with threads, or even <a href="http://mishadoff.com/blog/java-magic-part-4-sun-dot-misc-dot-unsafe/">hack in multiple inheritance</a>. Multiple people have <a href=https://dzone.com/articles/understanding-sunmiscunsafe>written about Unsafe</a> before, and there are some really <a href=http://mydailyjava.blogspot.com/2013/12/sunmiscunsafe.html>good articles</a>, so we won’t cover it here.</p><p>Using unsafe is not too difficult, but I found the need for a few helper methods, thus I created a collection of classes wrapping the Unsafe code, starting with <a href=https://bramp.github.io/unsafe/index.html?net/bramp/unsafe/UnsafeHelper.html>UnsafeHelper</a>. The main methods of interest are <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#getUnsafe-->getUnsafe()</a>, <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#sizeOf-java.lang.Object->sizeOf()</a>, <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#firstFieldOffset-java.lang.Class->firstFieldOffset()</a>, <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#toByteArray-java.lang.Object->toByteArray()</a> and <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#hexDump-java.io.PrintStream-java.lang.Object->hexDump()</a>. The <a href="https://bramp.github.io/unsafe/">javadoc</a> is the best place to look for documentation, however I’ll quickly explain their use.</p><p>To get an sun.misc.Unsafe instance, you have to extract it from a private static field within sun.misc.Unsafe class. For ease, the <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#getUnsafe-->UnsafeHelper.getUnsafe()</a> method does that.</p><p>When accessing an object, you typically need to know the size of the object (in bytes), and be able to find the offset to individual fields. If you <a href=http://www.codeinstructions.com/2008/12/java-objects-memory-structure.html>understand the memory layout</a> the JVM uses, you’ll know there is a header in front of the Object’s fields. Typically it looks like this, but varies based on CPU architecture, platform, etc:</p><p><table class="table table-bordered" style=margin-bottom:0><tr><th class=text-center>0<th class=text-center>1<th class=text-center>2<th class=text-center>3<th class=text-center>4<th class=text-center>5<th class=text-center>6<th class=text-center>7<th class=text-center>8<th class=text-center>9<th class=text-center>10<th class=text-center>11<th class=text-center>12<th class=text-center>13<th class=text-center>14<th class=text-center>15<tr><td class=text-center colspan=8>mark word(8)<td class=text-center colspan=4>klass pointer(4)<td class=text-center colspan=4>padding</table><div class=text-right>More information <a href=http://www.codeinstructions.com/2008/12/java-objects-memory-structure.html>here</a> and <a href=http://stackoverflow.com/a/17348396/88646>here</a>.</div></p><p>To hide some of the details, <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#headerSize-java.lang.Object->headerSize()</a> returns the size of the header, and <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#sizeOf-java.lang.Object->sizeOf()</a> return the total size an object including the header in bytes. <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#firstFieldOffset-java.lang.Class->firstFieldOffset()</a> is then useful as it provides the the offset to the first field. Note that <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#headerSize-java.lang.Object->headerSize()</a> and <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#firstFieldOffset-java.lang.Class->firstFieldOffset()</a> do not always return identical results, as padding (not part of the header) may be used to correctly align the first field.</p><p>Next <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#toByteArray-java.lang.Object->toByteArray()</a> will take an object, and copy it (and its header) into a byte array. Useful for easily inspecting, and serialising the object. Finally, <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#hexDump-java.io.PrintStream-java.lang.Object->hexDump()</a> uses the <a href=https://bramp.github.io/unsafe/net/bramp/unsafe/UnsafeHelper.html#toByteArray-java.lang.Object->toByteArray()</a> to grab an object, and print out a hex representation of the memory, for example:</p><div class=highlight><pre><code class=language-java data-lang=java><span class=cm>/**</span>
<span class=cm> * hexDump(new Class4()) prints:</span>
<span class=cm> * 0x00000000: 01 00 00 00 00 00 00 00  8A BF 62 DF 67 45 23 01</span>
<span class=cm> */</span>
<span class=kd>static</span> <span class=kd>class</span> <span class=nc>Class4</span> <span class=o>{</span>
    <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mh>0x01234567</span><span class=o>;</span>
<span class=o>}</span>

<span class=cm>/**</span>
<span class=cm> * Longs are always 8 byte aligned, so 4 bytes of padding</span>
<span class=cm> * hexDump(new Class8()) prints:</span>
<span class=cm> * 0x00000000: 01 00 00 00 00 00 00 00  9B 81 61 DF 00 00 00 00</span>
<span class=cm> * 0x00000010: EF CD AB 89 67 45 23 01</span>
<span class=cm> */</span>
<span class=kd>static</span> <span class=kd>class</span> <span class=nc>Class8</span> <span class=o>{</span>
    <span class=kt>long</span> <span class=n>l</span> <span class=o>=</span> <span class=mh>0x0123456789ABCDEF</span><span class=n>L</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></div><p>In the first example, Class4, a simple class with a single int field, takes up 16 bytes of memory, with the first 8 used by the JVM, the 2nd 4 bytes being a class pointer (basically how the object knows what kind of class it is), and the last four actually being the value of the field. The second example shows a similar header, but with bytes 12-16 being used as padding, so that the long field value is 8 byte aligned.</p><p>These helper methods are available in <a href=https://github.com/bramp/unsafe>new project on Github</a>, and downloadable via Maven. Just <a href=https://oss.sonatype.org/service/local/repositories/releases/content/net/bramp/unsafe/unsafe-helper/1.0/unsafe-helper-1.0.jar>download the jar file</a>, or include a maven dependency, and <code>import net.bramp.unsafe.UnsafeHelper</code>.</p><div class=highlight><pre><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>net.bramp.unsafe<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>unsafe-helper<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>1.0<span class=nt>&lt;/version&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></div><p><a href="https://blog.bramp.net/post/2015/08/26/unsafe-part-2-using-sun.misc.unsafe-to-create-a-contiguous-array-of-objects/">Next article</a>, we&rsquo;ll make use of this new UnsafeHelper to build a special List which copies objects, instead of storing references.</p></div></div><div class=row><div class=col-sm-6><div class=addthis_sharing_toolbox></div></div><div class=col-sm-6><div class=btn-toolbar><div class=btn-group><a class="btn btn-sm btn-soundcloud" href=https://feeds.feedburner.com/brampnet aria-label="RSS feed"><i class="fa fa-rss-square"></i> Subscribe via RSS</a></div><div class=btn-group><a class="btn btn-sm btn-twitter" href=https://twitter.com/TheBramp><i class="fa fa-twitter"></i> Follow @TheBramp</a></div></div></div></div><ul class=pager>&nbsp;<li class=previous><a href="/post/2015/08/07/introducing-hilbert/">&larr; Introducing Hilbert. A Go library to map values onto a Hilbert curve.</a></li>&nbsp;<li class=next><a href="/post/2015/08/26/unsafe-part-2-using-sun.misc.unsafe-to-create-a-contiguous-array-of-objects/">Unsafe Part 2: Using sun.misc.Unsafe to create a contiguous array of objects &rarr;</a></li></ul><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'bramp';
    var disqus_identifier = 'https:\/\/blog.bramp.net\/post\/2015\/08\/24\/unsafe-part-1-sun.misc.unsafe-helper-classes\/';
    var disqus_title = 'Unsafe Part 1: sun.misc.Unsafe Helper Classes';
    var disqus_url = 'https:\/\/blog.bramp.net\/post\/2015\/08\/24\/unsafe-part-1-sun.misc.unsafe-helper-classes\/';
    (function() {
	    
	    
	    if (window.location.host.lastIndexOf(":1313") >= 0)
	        return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><br/><footer><p class="text-muted credit">&copy; 2016. All rights reserved.</p></footer></div></div><script src=/js/all.min.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-559846a374d7ecaa" async></script><script type=text/javascript>rg4js('apiKey', 'k+jSb0g6maaeqIKOsR9PHw==');
  rg4js('enablePulse', true);
  rg4js('enableCrashReporting', false);</script>