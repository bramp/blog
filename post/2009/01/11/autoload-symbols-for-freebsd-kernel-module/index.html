<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <title>Autoload symbols for FreeBSD kernel module</title> <meta name=description content=""> <meta name=viewport content="width=device-width,initial-scale=1"> <meta name=generator content="Hugo"/> <link rel=canonical href="https://bramp.github.io/post/2009/01/11/autoload-symbols-for-freebsd-kernel-module/"/> <link href="" rel=alternate type=application/rss+xml title="Autoload symbols for FreeBSD kernel module"/> <link href=/css/bootstrap.min.css rel=stylesheet> <link href=/css/bramp.css rel=stylesheet> <link href=/css/pygments-friendly.css rel=stylesheet> <link href=//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css rel=stylesheet> <meta name=twitter:card content="summary"/> <meta name=twitter:site content="@TheBramp"/> <meta name=twitter:title content="Autoload symbols for FreeBSD kernel module"/> <meta name=twitter:description content=""/> <body> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-136478-5","auto"),ga("send","pageview");</script><div id=wrapper> <div class="navbar navbar-default" role=navigation> <div class=container> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse> <span class=sr-only>Toggle navigation</span>    </button> <div class=navbar-brand> <a href="/"> <img src="//secure.gravatar.com/avatar/69259b422a1a9266e17977f8ec9d939e?s=64" class=profile-image alt=Home> </a> <div> <a href="/about-me/">Andrew Brampton</a> <div id=social-wrapper> <a href=https://twitter.com/TheBramp></a> <a href=https://www.linkedin.com/in/bramp></a> <a href=https://www.facebook.com/bramp></a> <a href=https://github.com/bramp></a> <a href=/index.xml></a> </div> </div> </div> </div> <div class="navbar-collapse collapse"> <ul class="nav navbar-nav"> <li><a href="/">Articles</a></li> <li><a href="/about-me/">About Me</a></li> <li><a href="/android-app/">Android Apps</a></li> <li><a href="/opensource-project/">Open Source</a></li> <li><a href="/publication/">Publications</a></li> </ul> </div> </div> </div> <div class="container main"> <div id=article> <h1>Autoload symbols for FreeBSD kernel module</h1> <p class=meta>  2009-01-11 | <a href=https://bramp.github.io/tags/debug>debug</a> | <a href=https://bramp.github.io/tags/freebsd>FreeBSD</a> | <a href=https://bramp.github.io/tags/gdb>gdb</a> | <a href=https://bramp.github.io/tags/kernel>kernel</a> | <a href=https://bramp.github.io/tags/python>python</a> </p> <div class=post> <p>When debugging FreeBSD kernel modules with GDB, you have to tell GDB the correct symbols for the module, and the location the module is loaded in RAM. This is helpfully explained in the <a href=http://www.freebsd.org/doc/en/books/developers-handbook/kerneldebug-kld.html>FreeBSD Developers&#8217; Handbook</a>. First you must load the module, then run kldstat, note down the address the module is loaded at, and finally execute a command in GDB that looks like the following.</p> <div class=highlight><pre>add-symbol-file /sys/modules/linux/linux.ko 0xc0ae22d0
</pre></div> <p>However, I find this process tedious, so instead I wrote a quick python script which can be used with an <a href=http://sourceware.org/gdb/wiki/PythonGdb>experimental gdb built with python scripting support</a>.</p> <p>So here is the script:</p> <div class=highlight><pre><span class=kn>import</span> <span class=nn>gdb</span>
<span class=k>class</span> <span class=nc>FreeBSD_ReloadModuleSymbols</span> <span class=p>(</span><span class=n>gdb</span><span class=o>.</span><span class=n>Command</span><span class=p>):</span>
	<span class=s>&quot;Reloads the symbol files for all loaded kernel modules&quot;</span>

	<span class=k>def</span> <span class=nf>__init__</span> <span class=p>(</span><span class=bp>self</span><span class=p>):</span>
		<span class=nb>super</span> <span class=p>(</span><span class=n>FreeBSD_ReloadModuleSymbols</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>__init__</span> <span class=p>(</span><span class=s>&quot;reload-freebsd-module-symbols&quot;</span><span class=p>,</span>
			<span class=n>gdb</span><span class=o>.</span><span class=n>COMMAND_FILES</span><span class=p>,</span>
			<span class=n>gdb</span><span class=o>.</span><span class=n>COMPLETE_NONE</span><span class=p>)</span>

	<span class=k>def</span> <span class=nf>invoke</span> <span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>arg</span><span class=p>,</span> <span class=n>from_tty</span><span class=p>):</span>
		<span class=n>link</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>parse_and_eval</span><span class=p>(</span><span class=s>&quot;linker_files-&gt;tqh_first&quot;</span><span class=p>)</span>
		<span class=k>while</span> <span class=n>link</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
			<span class=k>print</span> <span class=n>link</span><span class=p>[</span><span class=s>&#39;filename&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>string</span><span class=p>()</span>
			<span class=k>if</span> <span class=n>link</span><span class=p>[</span><span class=s>&#39;filename&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>string</span><span class=p>()</span> <span class=o>!=</span> <span class=s>&quot;kernel&quot;</span><span class=p>:</span>
				<span class=n>gdb</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span> <span class=s>&quot;add-symbol-file &quot;</span> <span class=o>+</span> 
					<span class=n>link</span><span class=p>[</span><span class=s>&#39;pathname&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>string</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot; &quot;</span> <span class=o>+</span>  
					<span class=nb>str</span><span class=p>(</span><span class=n>link</span><span class=p>[</span><span class=s>&#39;address&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>address</span><span class=p>())</span> <span class=p>)</span>
			<span class=n>link</span> <span class=o>=</span> <span class=n>link</span><span class=p>[</span><span class=s>&#39;link&#39;</span><span class=p>][</span><span class=s>&#39;tqe_next&#39;</span><span class=p>]</span>

<span class=n>FreeBSD_ReloadModuleSymbols</span> <span class=p>()</span>
</pre></div> <p>You load this by running the following command in GDB:</p> <div class=highlight><pre><span class=nb>source </span>freebsd_load_modules.py
</pre></div> <p>Then the command <code>reload-freebsd-module-symbols</code> is magically added to GDB. Running this command will parse the linker table inside the FreeBSD kernel, determine which modules are loaded, and attempt to load their symbols.</p> </div> </div>  <ul class=pager> &nbsp;<li class=previous><a href="/post/2009/01/11/linuxoffsets-for-freebsd/">&larr; linuxoffsets for FreeBSD</a></li> &nbsp;<li class=next><a href="/post/2009/01/21/read/write-permissions-for-php-scripts-at-lancs.ac.uk/"> Read/Write permissions for PHP scripts at lancs.ac.uk &rarr;</a></li> </ul>  <script type=text/javascript>!function(){if("localhost"!=window.location.hostname&&1313!=window.location.port){var e=document.createElement("script");e.type="text/javascript",e.async=!0;var t="";e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> <br/> <footer> <p class="text-muted credit">&copy; 2015. All rights reserved. </p> </footer> </div> </div> <script src=/js/jquery-1.10.2.min.js></script><script src=/js/bootstrap.min.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-559846a374d7ecaa" async></script>