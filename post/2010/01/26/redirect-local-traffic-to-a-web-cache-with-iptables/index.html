<!DOCTYPE html><html lang=en><head><meta charset=utf-8><title>Redirect local traffic to a web cache with iptables</title><meta name=description content="Very occasionally I come across a Linux application that does not respect the http_proxy variable. This stops the application from working while I&#8217;m at university as they forbid traffic on port 80 unless it goes via their webcache. So today I came up with a hack of a solution that involves iptables: # IP address and port number of the webcache WEBCACHE=194.80.32.10:8080 # Flush any previous rules iptables -t nat --flush # Delete and recreate the chain iptables -t nat -X HTTPFORCE iptables -t nat -N HTTPFORCE # Don&#39;t touch local traffic (localhost and internal network) iptables -t nat -A HTTPFORCE -o lo -j RETURN iptables -t nat -A HTTPFORCE --dst 127.0.0.1/8 -j RETURN iptables -t nat -A HTTPFORCE --dst 10.0.0.0/8 -j RETURN # Add any other local networks here."><meta name=author content="Andrew Brampton"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo"/><link rel=canonical href="https://blog.bramp.net/post/2010/01/26/redirect-local-traffic-to-a-web-cache-with-iptables/"/><link href=/css/bootstrap.min.css rel=stylesheet><link href=/css/bramp.css rel=stylesheet><link href=/css/pygments-friendly.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css rel=stylesheet><meta name=twitter:card content="summary"/><meta name=twitter:site content="@TheBramp"/><meta name=twitter:title content="Redirect local traffic to a web cache with iptables"/><meta name=twitter:url content="https://blog.bramp.net/post/2010/01/26/redirect-local-traffic-to-a-web-cache-with-iptables/"/><meta name=twitter:creator content="@TheBramp"/><meta name=twitter:description content="Very occasionally I come across a Linux application that does not respect the http_proxy variable. This stops the application from working while I&#8217;m at university as they forbid traffic on port 80 unless it goes via their webcache. So today I came up with a hack of a solution that involves iptables: # IP address and port number of the webcache WEBCACHE=194.80.32.10:8080 # Flush any previous rules iptables -t nat --flush # Delete and recreate the chain iptables -t nat -X HTTPFORCE iptables -t nat -N HTTPFORCE # Don&#39;t touch local traffic (localhost and internal network) iptables -t nat -A HTTPFORCE -o lo -j RETURN iptables -t nat -A HTTPFORCE --dst 127.0.0.1/8 -j RETURN iptables -t nat -A HTTPFORCE --dst 10.0.0.0/8 -j RETURN # Add any other local networks here."/><meta property=og:type content="article"/><meta property=article:author content="https://www.facebook.com/bramp"/><meta property=article:published_time content="2010-01-26T00:00:00&#43;07:00"/><meta property=article:tag content="iptables"/><meta property=article:tag content="Linux"/><meta property=article:tag content="webcache"/><meta property=og:url content="https://blog.bramp.net/post/2010/01/26/redirect-local-traffic-to-a-web-cache-with-iptables/"/><meta property=og:site_name content="bramp.net"/><meta property=og:title content="Redirect local traffic to a web cache with iptables"/><meta property=og:description content="Very occasionally I come across a Linux application that does not respect the http_proxy variable. This stops the application from working while I&#8217;m at university as they forbid traffic on port 80 unless it goes via their webcache. So today I came up with a hack of a solution that involves iptables: # IP address and port number of the webcache WEBCACHE=194.80.32.10:8080 # Flush any previous rules iptables -t nat --flush # Delete and recreate the chain iptables -t nat -X HTTPFORCE iptables -t nat -N HTTPFORCE # Don&#39;t touch local traffic (localhost and internal network) iptables -t nat -A HTTPFORCE -o lo -j RETURN iptables -t nat -A HTTPFORCE --dst 127.0.0.1/8 -j RETURN iptables -t nat -A HTTPFORCE --dst 10.0.0.0/8 -j RETURN # Add any other local networks here."/><meta property=og:updated_time content="2010-01-26T00:00:00&#43;00:00"/><meta property=og:locale content="en_GB"/><meta name=google-site-verification content="RXqIC-7spNUYReoHFlubz8Fbqsg1fC1pE6FSgSnCNjQ"/><script></script><body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-136478-5', 'auto');
    ga('send', 'pageview');</script><div id=wrapper><div class="navbar navbar-default" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button><div class=navbar-brand><a href="/"><img src="//secure.gravatar.com/avatar/69259b422a1a9266e17977f8ec9d939e?s=64" class=profile-image alt=Home></a><div><a href="/about-me/">Andrew Brampton</a><div id=social-wrapper><a href=https://twitter.com/TheBramp><i class="fa fa-twitter-square"></i></a> <a href=https://www.linkedin.com/in/bramp><i class="fa fa-linkedin-square"></i></a> <a href=https://www.facebook.com/bramp><i class="fa fa-facebook-square"></i></a> <a href=https://github.com/bramp><i class="fa fa-github-square"></i></a> <a href=/index.xml><i class="fa fa-rss-square"></i></a></div></div></div></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href="/">Articles</a></li><li><a href="/about-me/">About Me</a></li><li><a href="/android-app/">Android Apps</a></li><li><a href="/opensource-project/">Open Source</a></li><li><a href="/publication/">Publications</a></li></ul></div></div></div><div class="container main"><div id=article><h1>Redirect local traffic to a web cache with iptables</h1><p class=meta><i class="fa fa-calendar-o"></i> 2010-01-26 | <a href="https://blog.bramp.net/tags/iptables/">iptables</a> | <a href="https://blog.bramp.net/tags/linux/">Linux</a> | <a href="https://blog.bramp.net/tags/webcache/">webcache</a></p><div class=post><p>Very occasionally I come across a Linux application that does not respect the http_proxy variable. This stops the application from working while I&#8217;m at university as they forbid traffic on port 80 unless it goes via their webcache. So today I came up with a hack of a solution that involves iptables:</p><div class=highlight><pre><span class=c># IP address and port number of the webcache</span>
<span class=nv>WEBCACHE</span><span class=o>=</span>194.80.32.10:8080

<span class=c># Flush any previous rules</span>
iptables -t nat --flush

<span class=c># Delete and recreate the chain</span>
iptables -t nat -X HTTPFORCE
iptables -t nat -N HTTPFORCE

<span class=c># Don&#39;t touch local traffic (localhost and internal network)</span>
iptables -t nat -A HTTPFORCE -o lo -j RETURN
iptables -t nat -A HTTPFORCE --dst 127.0.0.1/8 -j RETURN
iptables -t nat -A HTTPFORCE --dst 10.0.0.0/8 -j RETURN
<span class=c># Add any other local networks here.</span>

<span class=c># Now we have two options. Please uncomment out one of them</span>
<span class=c># 1) Redirect packets on port 80 to the webcache</span>
<span class=c>#    This may not work unless the webcache is generous with its input</span>
<span class=c>#iptables -t nat -A HTTPFORCE -p tcp --dport 80 -j DNAT --to $WEBCACHE</span>

<span class=c># 2) Redirect packets on port 80 to localhost port 1234</span>
<span class=c>#    On port 1234 you need to run a local web proxy, which forwards </span>
<span class=c>#    requests to the real webcache</span>
<span class=c>#iptables -t nat -A HTTPFORCE -p tcp --dport 80 -j REDIRECT --to-port 1234</span>

<span class=c># Capture all outgoing TCP syns</span>
iptables -t nat -A OUTPUT -p tcp --syn -j HTTPFORCE
</pre></div><p>All outgoing TCP packets on port 80 which are not destined for a local network are captured and changed in one of two ways. The first option just manipulates the IP/TCP header, and the second redirects the traffic to a proxy running on localhost. The reason for the two options was that my university&#8217;s webcache seemed unable to deal with HTTP requests without the full URL in the GET line, even though the request contains a valid Host header. I think this is a misconfiguration of their squid proxy, so instead you can redirect to a local proxy which forwards the request on to the webcache.</p><p>This all seems a hassle but sometimes it is needed when a application does not respect the http_proxy environment. On a good note all libcurl applications should respect it by default.</p></div></div><div class=addthis_sharing_toolbox></div><ul class=pager>&nbsp;<li class=previous><a href="/post/2010/01/14/installing-packages-into-your-user-directory/">&larr; Installing packages into your user directory</a></li>&nbsp;<li class=next><a href="/post/2010/02/13/latex-qr-based-business-card/">LaTeX QR Based Business Card &rarr;</a></li></ul><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = '';
    var disqus_identifier = 'https:\/\/blog.bramp.net\/post\/2010\/01\/26\/redirect-local-traffic-to-a-web-cache-with-iptables\/';
    var disqus_title = 'Redirect local traffic to a web cache with iptables';
    var disqus_url = 'https:\/\/blog.bramp.net\/post\/2010\/01\/26\/redirect-local-traffic-to-a-web-cache-with-iptables\/';
    (function() {
	    
	    
	    if (window.location.hostname == "localhost")
	        return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><br/><footer><p class="text-muted credit">&copy; 2015. All rights reserved.</p></footer></div></div><script src=/js/jquery-1.10.2.min.js></script><script src=/js/bootstrap.min.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-559846a374d7ecaa" async></script>