<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Autoload symbols for FreeBSD kernel module</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo"/>
  <link href="" rel="alternate" type="application/rss+xml" title="bramp.net" />
  <link href="http://bramp.net/blog/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://bramp.net/blog/css/bramp.css" rel="stylesheet">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  
  
    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-136478-5', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>

<div id = "wrapper">

  <div class="navbar navbar-default" role="navigation">
      <div class="container">

        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-brand">
            <a href="http://bramp.net/blog">
              <img src="//secure.gravatar.com/avatar/69259b422a1a9266e17977f8ec9d939e?s=64" class="profile-image" alt="Home">
            </a>
            <div>
              <a href="http://bramp.net/blog/about-me/">Andrew Brampton</a>

              <div id="social-wrapper">
              
                <a href="https://twitter.com/@TheBramp"><i class="fa fa-twitter-square"></i></a>
              
              
                <a href="https://www.linkedin.com/in/bramp"><i class="fa fa-linkedin-square"></i></a>
              
              
                <a href="https://www.facebook.com/bramp"><i class="fa fa-facebook-square"></i></a>
              
                <a href="https://github.com/bramp"><i class="fa fa-github-square"></i></a>
              
                <a href="http://bramp.net/blog/index.xml"><i class="fa fa-rss-square"></i></a>
             </div>
            </div>
          </div>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="http://bramp.net/blog/about-me/">About Me</a></li>
            <li><a href="http://bramp.net/blog/android-apps/">Android Apps</a></li>
            <li><a href="http://bramp.net/blog/posts/">Articles</a></li>
            <li><a href="http://bramp.net/blog/opensource-projects/">Open Source</a></li>
            <li><a href="http://bramp.net/blog/publications/">Publications</a></li>
          </ul>
        </div>
      </div>
    </div>

     <div class="container main">


  <div id="article">
   <h1>Autoload symbols for FreeBSD kernel module</h1>
   <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2009-01-11</small> 204 words</p> <hr/>
   <div class="post">
     <p>When debugging FreeBSD kernel modules with GDB, you have to tell GDB the correct symbols for the module, and the location the module is loaded in RAM. This is helpfully explained in the <a href="http://www.freebsd.org/doc/en/books/developers-handbook/kerneldebug-kld.html">FreeBSD Developers&#8217; Handbook</a>. First you must load the module, then run kldstat, note down the address the module is loaded at, and finally execute a command in GDB that looks like the following.</p>

<pre>add-symbol-file /sys/modules/linux/linux.ko 0xc0ae22d0</pre>

<p>However, I find this process tedious, so instead I wrote a quick python script which can be used with an [experimental gdb built with python scripting support][2].</p>

<p>So here is the script:</p>

<pre class="prettyprint">import gdb
class FreeBSD_ReloadModuleSymbols (gdb.Command):
    "Reloads the symbol files for all loaded kernel modules"

    def __init__ (self):
        super (FreeBSD_ReloadModuleSymbols, self).__init__ ("reload-freebsd-module-symbols",
            gdb.COMMAND_FILES,
            gdb.COMPLETE_NONE)

    def invoke (self, arg, from_tty):
        link = gdb.parse_and_eval("linker_files-&gt;tqh_first")
        while link != 0:
            print link['filename'].string()
            if link['filename'].string() != "kernel":
                gdb.execute( "add-symbol-file " + 
                    link['pathname'].string() + " " +  
                    str(link['address'].address()) )
            link = link['link']['tqe_next']

FreeBSD_ReloadModuleSymbols ()
</pre>

<p>You load this by running the following command in GDB:</p>

<pre>source freebsd_load_modules.py</pre>

<p>Then the command &#8220;reload-freebsd-module-symbols&#8221; is magically added to GDB. Running this command will parse the linker table inside the FreeBSD kernel, determine which modules are loaded, and attempt to load their symbols.</p>

<p>[2]: <a href="http://sourceware.org/gdb/wiki/PythonGdb">http://sourceware.org/gdb/wiki/PythonGdb</a></p>

   </div>
 </div>


 <a href="https://twitter.com/share" class="twitter-share-button " data-size="small" data-count="none">Tweet</a>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

 <ul class="pager">
      &nbsp;<li class="previous"><a href="http://bramp.net/blog/2009/01/21/read/write-permissions-for-php-scripts-at-lancs.ac.uk/">&larr; Read/Write permissions for PHP scripts at lancs.ac.uk</a></li>
      &nbsp;<li class="next"><a href="http://bramp.net/blog/2009/01/11/linuxoffsets-for-freebsd/"> linuxoffsets for FreeBSD &rarr;</a></li>
</ul>

<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost" || window.location.port == 1313) 
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = '';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <footer>
        <p class="text-muted credit">&copy; 2015. All rights reserved. </p>
    </footer>

    </div> 
    </div> 

	
    <script src="http://bramp.net/blog/js/jquery-1.10.2.min.js"></script>
    <script src="http://bramp.net/blog/js/bootstrap.min.js"></script>
  </body>
</html>

