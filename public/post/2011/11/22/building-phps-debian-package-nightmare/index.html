<!DOCTYPE html><html lang=en><head><meta charset=utf-8><title>Building PHP’s Debian package nightmare</title><meta name=description content="I just tried to compile the Debian PHP packages, so I could make some minor tweaks to the source, to fix a bug I&#8217;m hopefully going to document shortly. This turned out to be very problematic, mainly due to the testing phase!
To build the Debian packages you typically do the following:
mkdir php cd php apt-get source php5 cd php5-* debuild -us -uc -j4  While testing, the debian/setup_mysql.sh script is called, to create a temporary MySQL database."><meta name=author content="Andrew Brampton"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo"/><link rel=canonical href="https://blog.bramp.net/post/2011/11/22/building-phps-debian-package-nightmare/"/><link href=https://blog.bramp.net/index.xml rel=alternate type=application/rss+xml title="bramp.net"/><link href=https://blog.bramp.net/index.xml rel=feed type=application/rss+xml title="bramp.net"/><link rel="shortcut icon" href=/favicon.ico type="image/x-icon"/><link rel=apple-touch-icon-precomposed href="/images/favicon.png"/><link rel=apple-touch-icon-precomposed sizes=57x57 href="/images/favicon-57x57.png"/><link rel=apple-touch-icon-precomposed sizes=72x72 href="/images/favicon-72x72.png"/><link rel=apple-touch-icon-precomposed sizes=76x76 href="/images/favicon-76x76.png"/><link rel=apple-touch-icon-precomposed sizes=114x114 href="/images/favicon-114x114.png"/><link rel=apple-touch-icon-precomposed sizes=120x120 href="/images/favicon-120x120.png"/><link rel=apple-touch-icon-precomposed sizes=144x144 href="/images/favicon-144x144.png"/><link rel=apple-touch-icon-precomposed sizes=152x152 href="/images/favicon-152x152.png"/><link rel=apple-touch-icon-precomposed sizes=180x180 href="/images/favicon-180x180.png"/><meta name=msapplication-TileColor content=#4582EC><meta name=msapplication-TileImage content=/images/favicon-144x144.png><meta name=theme-color content=#4582EC><link rel=icon sizes=192x192 href="/images/favicon-192x192.png"/><link href=/css/all.min.css rel=stylesheet><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel=stylesheet type=text/css><link href=https://netdna.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/font-hack/2.010/css/hack.min.css><meta name=twitter:card content="summary"/><meta name=twitter:site content="@TheBramp"/><meta name=twitter:title content="Building PHP’s Debian package nightmare"/><meta name=twitter:url content="https://blog.bramp.net/post/2011/11/22/building-phps-debian-package-nightmare/"/><meta name=twitter:creator content="@TheBramp"/><meta name=twitter:description content="I just tried to compile the Debian PHP packages, so I could make some minor tweaks to the source, to fix a bug I&#8217;m hopefully going to document shortly. This turned out to be very problematic, mainly due to the testing phase!
To build the Debian packages you typically do the following:
mkdir php cd php apt-get source php5 cd php5-* debuild -us -uc -j4  While testing, the debian/setup_mysql.sh script is called, to create a temporary MySQL database."/><meta property=og:type content="article"/><meta property=article:author content="https://www.facebook.com/bramp"/><meta property=article:published_time content="2011-11-22T00:00:00&#43;07:00"/><meta property=article:tag content="build"/><meta property=article:tag content="debian"/><meta property=article:tag content="Linux"/><meta property=article:tag content="PHP"/><meta property=og:url content="https://blog.bramp.net/post/2011/11/22/building-phps-debian-package-nightmare/"/><meta property=og:site_name content="bramp.net"/><meta property=og:title content="Building PHP’s Debian package nightmare"/><meta property=og:description content="I just tried to compile the Debian PHP packages, so I could make some minor tweaks to the source, to fix a bug I&#8217;m hopefully going to document shortly. This turned out to be very problematic, mainly due to the testing phase!
To build the Debian packages you typically do the following:
mkdir php cd php apt-get source php5 cd php5-* debuild -us -uc -j4  While testing, the debian/setup_mysql.sh script is called, to create a temporary MySQL database."/><meta property=og:updated_time content="2011-11-22T00:00:00&#43;00:00"/><meta property=og:locale content="en_GB"/><meta name=google-site-verification content="RXqIC-7spNUYReoHFlubz8Fbqsg1fC1pE6FSgSnCNjQ"/><body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-136478-5', 'auto');
    ga('require', 'linkid', 'linkid.js');
    ga('send', 'pageview');</script><div id=wrapper><div class="navbar navbar-default"><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button><div class=navbar-brand aria-label="About Andrew Brampton"><a href="/"><img src=/images/favicon-64x64.png class=profile-image alt=Home></a><div><a href="/about-me/">Andrew Brampton</a><div id=social-wrapper><a href=https://twitter.com/TheBramp aria-label=Twitter><i class="fa fa-twitter-square"></i></a> <a href=https://www.linkedin.com/in/bramp aria-label=LinkedIn><i class="fa fa-linkedin-square"></i></a> <a href=https://www.facebook.com/bramp aria-label=Facebook><i class="fa fa-facebook-square"></i></a> <a href=https://github.com/bramp aria-label=GitHub><i class="fa fa-github-square"></i></a> <a href=https://feeds.feedburner.com/brampnet aria-label="RSS feed"><i class="fa fa-rss-square"></i></a></div></div></div></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav" role=navigation><li><a href="/">Articles</a></li><li><a href="/about-me/">About Me</a></li><li><a href="/android-app/">Android Apps</a></li><li><a href="/opensource-project/">Open Source</a></li><li><a href="/publication/">Publications</a></li></ul></div></div></div><div class="container main"><div id=article><h1>Building PHP’s Debian package nightmare</h1><p class=meta><i class="fa fa-calendar-o"></i> 2011-11-22 | <a href="https://blog.bramp.net/tags/build/">build</a> | <a href="https://blog.bramp.net/tags/debian/">debian</a> | <a href="https://blog.bramp.net/tags/linux/">Linux</a> | <a href="https://blog.bramp.net/tags/php/">PHP</a></p><div class=post><p>I just tried to compile the Debian PHP packages, so I could make some <a href=http://www.howtoforge.com/recompiling-php5-with-bundled-support-for-gd-on-ubuntu>minor tweaks</a> to the source, to fix a bug I&#8217;m hopefully going to document shortly. This turned out to be very problematic, mainly due to the testing phase!</p><p>To build the Debian packages you typically do the following:</p><div class=highlight><pre><code class=language-bash data-lang=bash>mkdir php
<span class=nb>cd </span>php
apt-get <span class=nb>source </span>php5
<span class=nb>cd </span>php5-*
debuild -us -uc -j4
</code></pre></div><p>While testing, the debian/setup_mysql.sh script is called, to create a temporary MySQL database. This however failed to execute correctly because I had some custom options in my <a href=http://dev.mysql.com/doc/refman/5.1/en/option-files.html>~/.my.cnf</a>. Thus it failed like so:</p><div class=highlight><pre><code class=language-bash data-lang=bash><span class=c># start our own mysql server for the tests</span>
/bin/sh debian/setup-mysql.sh <span class=m>1029</span> /home/bramp/vendor/php/php5-5.3.8.0/mysql_db
mysqladmin: connect to server at <span class=s1>&#39;localhost&#39;</span> failed
error: <span class=s1>&#39;Access denied for user &#39;</span>root<span class=s1>&#39;@&#39;</span>localhost<span class=s1>&#39; (using password: YES)&#39;</span>
make: *** <span class=o>[</span><span class=nb>test</span>-results.txt<span class=o>]</span> Error 1
dpkg-buildpackage: error: debian/rules build gave error <span class=nb>exit </span>status 2
debuild: fatal error at line 1348:
dpkg-buildpackage -rfakeroot -D -us -uc -j8 failed
</code></pre></div><p>After removing the my.cnf things were ok. The below patch fixes it in a more general way:</p><div class=highlight><pre><code class=language-diff data-lang=diff><span class=gd>-- debian/setup-mysql.sh.org	2011-11-21 21:57:07.244481175 -0500</span>
<span class=gi>+++ debian/setup-mysql.sh	2011-11-21 21:40:39.384455880 -0500</span>
<span class=gu>@@ -16,7 +16,7 @@</span>
 
 socket=$datadir/mysql.sock
 # Commands:
<span class=gd>-mysqladmin=&quot;mysqladmin -u root -P $port -h localhost --socket=$socket&quot;</span>
<span class=gi>+mysqladmin=&quot;mysqladmin --no-defaults -u root -P $port -h localhost --socket=$socket&quot;</span>
 mysqld=&quot;/usr/sbin/mysqld --no-defaults --bind-address=localhost --port=$port --socket=$socket --datadir=$datadir&quot;
 
 # Main code #
</code></pre></div><p>The next problem I encountered is that all the automated PHP unit tests were failing, and they would eventually get stuck and use all my RAM and swap space (at least 16GiB of it) :( I&#8217;m not sure what made the machine run out of RAM, but the tests were failing because the version of PHP that was running the tests was incorrectly loading extensions from my system. The quick fix for this was to disable any extensions I had installed to my system. I just</p><div class=highlight><pre><code class=language-bash data-lang=bash>sudo mv /etc/php5/conf.d /etc/php5/conf.d.tmp
</code></pre></div><p>to do that.</p><p>This made me think that in future I should perhaps find a cleaner environment to build these packages. In fact, it makes me wonder if the builds are just broken if my environment clearly impacts the successful run of tests.</p><p>One trick I found while building again and again, is that you can pass &#8220;-nc&#8221; to debuild so that it does not clean, and thus reuses the existing build materials for a faster build. Either way, I now have my own version of PHP built and installed! Next time I might just ignore the .deb files and build direct from source.</p></div></div><div class=row><div class=col-sm-6><div class=addthis_sharing_toolbox></div></div><div class=col-sm-6><div class=btn-toolbar><div class=btn-group><a class="btn btn-sm btn-soundcloud" href=https://feeds.feedburner.com/brampnet aria-label="RSS feed"><i class="fa fa-rss-square"></i> Subscribe via RSS</a></div><div class=btn-group><a class="btn btn-sm btn-twitter" href=https://twitter.com/TheBramp><i class="fa fa-twitter"></i> Follow @TheBramp</a></div></div></div></div><ul class=pager>&nbsp;<li class=previous><a href="/post/2011/11/09/i-am-gnome/">&larr; I am GNOME</a></li>&nbsp;<li class=next><a href="/post/2011/11/26/php-polygon-clipper-using-the-sutherland-hodgman-algorithm/">PHP Polygon Clipper using the Sutherland-Hodgman algorithm &rarr;</a></li></ul><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'bramp';
    var disqus_identifier = 'https:\/\/blog.bramp.net\/post\/2011\/11\/22\/building-phps-debian-package-nightmare\/';
    var disqus_title = 'Building PHP’s Debian package nightmare';
    var disqus_url = 'https:\/\/blog.bramp.net\/post\/2011\/11\/22\/building-phps-debian-package-nightmare\/';
    (function() {
	    
	    
	    if (window.location.host.lastIndexOf(":1313") >= 0)
	        return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><br/><footer><p class="text-muted credit">&copy; 2017. All rights reserved.</p></footer></div></div><script src=/js/all.min.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-559846a374d7ecaa" async></script>