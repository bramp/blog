<!DOCTYPE html><html lang=en><head><meta charset=utf-8><title>Follow HTTP Stream (with decompression)</title><meta name=description content="I was using Wireshark to capture an exchange of HTTP packets, however, some of the HTTP responses were using &#8220;content-encoding: gzip&#8221;, which meant I couldn&#8217;t view them decompressed in the &#8220;Follow TCP Stream&#8221;. Wireshark does decompress them in Packet Details view, but it is hard to follow the full stream like this. The solution was to write some Python which made use of the dpkt library. My code naively reassembles the TCP flow and then assumes traffic on port 80 is HTTP."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo"/><link rel=canonical href="https://blog.bramp.net/post/2010/01/10/follow-http-stream-with-decompression/"/><link href=/css/bootstrap.min.css rel=stylesheet><link href=/css/bramp.css rel=stylesheet><link href=/css/pygments-friendly.css rel=stylesheet><link href=//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css rel=stylesheet><meta name=twitter:card content="summary"/><meta name=twitter:site content="@TheBramp"/><meta name=twitter:title content="Follow HTTP Stream (with decompression)"/><meta name=twitter:url content="https://blog.bramp.net/post/2010/01/10/follow-http-stream-with-decompression/"/><meta name=twitter:description content="I was using Wireshark to capture an exchange of HTTP packets, however, some of the HTTP responses were using &#8220;content-encoding: gzip&#8221;, which meant I couldn&#8217;t view them decompressed in the &#8220;Follow TCP Stream&#8221;. Wireshark does decompress them in Packet Details view, but it is hard to follow the full stream like this. The solution was to write some Python which made use of the dpkt library. My code naively reassembles the TCP flow and then assumes traffic on port 80 is HTTP."/><meta property=og:type content="article"/><meta property=article:author content="Andrew Brampton"/><meta property=article:published_time content="2010-01-10T00:00:00&#43;07:00"/><meta property=article:tag content="dpkt"/><meta property=article:tag content="gzip"/><meta property=article:tag content="http"/><meta property=article:tag content="pcap"/><meta property=article:tag content="python"/><meta property=og:url content="https://blog.bramp.net/post/2010/01/10/follow-http-stream-with-decompression/"/><meta property=og:site_name content="bramp.net"/><meta property=og:title content="Follow HTTP Stream (with decompression)"/><meta property=og:description content="I was using Wireshark to capture an exchange of HTTP packets, however, some of the HTTP responses were using &#8220;content-encoding: gzip&#8221;, which meant I couldn&#8217;t view them decompressed in the &#8220;Follow TCP Stream&#8221;. Wireshark does decompress them in Packet Details view, but it is hard to follow the full stream like this. The solution was to write some Python which made use of the dpkt library. My code naively reassembles the TCP flow and then assumes traffic on port 80 is HTTP."/><meta property=og:locale content="en_GB"/><meta name=google-site-verification content="RXqIC-7spNUYReoHFlubz8Fbqsg1fC1pE6FSgSnCNjQ"/><script></script><body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-136478-5', 'auto');
    ga('send', 'pageview');</script><div id=wrapper><div class="navbar navbar-default" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button><div class=navbar-brand><a href="/"><img src="//secure.gravatar.com/avatar/69259b422a1a9266e17977f8ec9d939e?s=64" class=profile-image alt=Home></a><div><a href="/about-me/">Andrew Brampton</a><div id=social-wrapper><a href=https://twitter.com/TheBramp><i class="fa fa-twitter-square"></i></a> <a href=https://www.linkedin.com/in/bramp><i class="fa fa-linkedin-square"></i></a> <a href=https://www.facebook.com/bramp><i class="fa fa-facebook-square"></i></a> <a href=https://github.com/bramp><i class="fa fa-github-square"></i></a> <a href=/index.xml><i class="fa fa-rss-square"></i></a></div></div></div></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href="/">Articles</a></li><li><a href="/about-me/">About Me</a></li><li><a href="/android-app/">Android Apps</a></li><li><a href="/opensource-project/">Open Source</a></li><li><a href="/publication/">Publications</a></li></ul></div></div></div><div class="container main"><div id=article><h1>Follow HTTP Stream (with decompression)</h1><p class=meta><i class="fa fa-calendar-o"></i> 2010-01-10 | <a href="https://blog.bramp.net/tags/dpkt/">dpkt</a> | <a href="https://blog.bramp.net/tags/gzip/">gzip</a> | <a href="https://blog.bramp.net/tags/http/">http</a> | <a href="https://blog.bramp.net/tags/pcap/">pcap</a> | <a href="https://blog.bramp.net/tags/python/">python</a></p><div class=post><p>I was using <a href="http://www.wireshark.org/">Wireshark</a> to capture an exchange of HTTP packets, however, some of the HTTP responses were using &#8220;content-encoding: gzip&#8221;, which meant I couldn&#8217;t view them decompressed in the &#8220;Follow TCP Stream&#8221;. Wireshark does decompress them in Packet Details view, but it is hard to follow the full stream like this.</p><p>The solution was to write some <a href="http://www.python.org/">Python</a> which made use of the <a href="http://code.google.com/p/dpkt/">dpkt library</a>. My code naively reassembles the TCP flow and then assumes traffic on port 80 is HTTP. Therefore there is much room for improvement, but here is the code anyway.</p><div class=highlight><pre><span class=c>#!/usr/bin/env python</span>
<span class=c># Turns a pcap file with http gzip compressed data into plain text, making it</span>
<span class=c># easier to follow.</span>

<span class=kn>import</span> <span class=nn>dpkt</span>

<span class=k>def</span> <span class=nf>tcp_flags</span><span class=p>(</span><span class=n>flags</span><span class=p>):</span>
    <span class=n>ret</span> <span class=o>=</span> <span class=s>&#39;&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_FIN</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;F&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_SYN</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;S&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_RST</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;R&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_PUSH</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;P&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_ACK</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;A&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_URG</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;U&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_ECE</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;E&#39;</span>
    <span class=k>if</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>tcp</span><span class=o>.</span><span class=n>TH_CWR</span><span class=p>:</span>
        <span class=n>ret</span> <span class=o>=</span> <span class=n>ret</span> <span class=o>+</span> <span class=s>&#39;C&#39;</span>

    <span class=k>return</span> <span class=n>ret</span>

<span class=k>def</span> <span class=nf>parse_http_stream</span><span class=p>(</span><span class=n>stream</span><span class=p>):</span>
    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>stream</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>stream</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#39;HTTP&#39;</span><span class=p>:</span>
            <span class=n>http</span> <span class=o>=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>Response</span><span class=p>(</span><span class=n>stream</span><span class=p>)</span>
            <span class=k>print</span> <span class=n>http</span><span class=o>.</span><span class=n>status</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>http</span> <span class=o>=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>(</span><span class=n>stream</span><span class=p>)</span>
            <span class=k>print</span> <span class=n>http</span><span class=o>.</span><span class=n>method</span><span class=p>,</span> <span class=n>http</span><span class=o>.</span><span class=n>uri</span>
        <span class=n>stream</span> <span class=o>=</span> <span class=n>stream</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>http</span><span class=p>):]</span>

<span class=k>def</span> <span class=nf>parse_pcap_file</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
    <span class=c># Open the pcap file</span>
    <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s>&#39;market.pcap&#39;</span><span class=p>,</span> <span class=s>&#39;rb&#39;</span><span class=p>)</span>
    <span class=n>pcap</span> <span class=o>=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>pcap</span><span class=o>.</span><span class=n>Reader</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
    
    <span class=c># I need to reassmble the TCP flows before decoding the HTTP</span>
    <span class=n>conn</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span> <span class=c># Connections with current buffer</span>
    <span class=k>for</span> <span class=n>ts</span><span class=p>,</span> <span class=n>buf</span> <span class=ow>in</span> <span class=n>pcap</span><span class=p>:</span>
        <span class=n>eth</span> <span class=o>=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>ethernet</span><span class=o>.</span><span class=n>Ethernet</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>eth</span><span class=o>.</span><span class=n>type</span> <span class=o>!=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>ethernet</span><span class=o>.</span><span class=n>ETH_TYPE_IP</span><span class=p>:</span>
            <span class=k>continue</span>
    
        <span class=n>ip</span> <span class=o>=</span> <span class=n>eth</span><span class=o>.</span><span class=n>data</span>
        <span class=k>if</span> <span class=n>ip</span><span class=o>.</span><span class=n>p</span> <span class=o>!=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>ip</span><span class=o>.</span><span class=n>IP_PROTO_TCP</span><span class=p>:</span>
            <span class=k>continue</span>
    
        <span class=n>tcp</span> <span class=o>=</span> <span class=n>ip</span><span class=o>.</span><span class=n>data</span>
    
        <span class=n>tupl</span> <span class=o>=</span> <span class=p>(</span><span class=n>ip</span><span class=o>.</span><span class=n>src</span><span class=p>,</span> <span class=n>ip</span><span class=o>.</span><span class=n>dst</span><span class=p>,</span> <span class=n>tcp</span><span class=o>.</span><span class=n>sport</span><span class=p>,</span> <span class=n>tcp</span><span class=o>.</span><span class=n>dport</span><span class=p>)</span>
        <span class=c>#print tupl, tcp_flags(tcp.flags)</span>
    
        <span class=c># Ensure these are in order! TODO change to a defaultdict</span>
        <span class=k>if</span> <span class=n>tupl</span> <span class=ow>in</span> <span class=n>conn</span><span class=p>:</span>
            <span class=n>conn</span><span class=p>[</span> <span class=n>tupl</span> <span class=p>]</span> <span class=o>=</span> <span class=n>conn</span><span class=p>[</span> <span class=n>tupl</span> <span class=p>]</span> <span class=o>+</span> <span class=n>tcp</span><span class=o>.</span><span class=n>data</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>conn</span><span class=p>[</span> <span class=n>tupl</span> <span class=p>]</span> <span class=o>=</span> <span class=n>tcp</span><span class=o>.</span><span class=n>data</span>
    
        <span class=c># TODO Check if it is a FIN, if so end the connection</span>
    
        <span class=c># Try and parse what we have</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>stream</span> <span class=o>=</span> <span class=n>conn</span><span class=p>[</span> <span class=n>tupl</span> <span class=p>]</span>
            <span class=k>if</span> <span class=n>stream</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#39;HTTP&#39;</span><span class=p>:</span>
                <span class=n>http</span> <span class=o>=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>Response</span><span class=p>(</span><span class=n>stream</span><span class=p>)</span>
                <span class=c>#print http.status</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>http</span> <span class=o>=</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>(</span><span class=n>stream</span><span class=p>)</span>
                <span class=c>#print http.method, http.uri</span>
    
            <span class=k>print</span> <span class=n>http</span>
            <span class=k>print</span>

            <span class=c># If we reached this part an exception hasn&#39;t been thrown</span>
            <span class=n>stream</span> <span class=o>=</span> <span class=n>stream</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>http</span><span class=p>):]</span>
            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>stream</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                <span class=k>del</span> <span class=n>conn</span><span class=p>[</span> <span class=n>tupl</span> <span class=p>]</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>conn</span><span class=p>[</span> <span class=n>tupl</span> <span class=p>]</span> <span class=o>=</span> <span class=n>stream</span>
        <span class=k>except</span> <span class=n>dpkt</span><span class=o>.</span><span class=n>UnpackError</span><span class=p>:</span>
            <span class=k>pass</span>

    <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>

<span class=k>if</span> <span class=n>__name__</span> <span class=o>==</span> <span class=s>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=kn>import</span> <span class=nn>sys</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
        <span class=k>print</span> <span class=s>&quot;</span><span class=si>%s</span><span class=s> &lt;pcap filename&gt;&quot;</span> <span class=o>%</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>

    <span class=n>parse_pcap_file</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</pre></div><p><strong>Please note</strong>, I had to make a couple of changes to the dpkt library, which I have submitted <a href=http://groups.google.com/group/dpkt/browse_thread/thread/5315199f9749b91a>back for review</a>. Those changes can be found in the following patches <a href=/patches/dpkt-pcap-snaplen.patch>1</a> <a href=/patches/dpkt-http-len.patch>2</a> <a href=/patches/dpkt-http-gz.patch>3</a>. I will update this code if/when the patches get accepted.</p></div></div><div class=addthis_sharing_toolbox></div><ul class=pager>&nbsp;<li class=previous><a href="/post/2009/12/19/updating/-%5C/-/">&larr; Updatingâ€¦/-\|/-|</a></li>&nbsp;<li class=next><a href="/post/2010/01/13/my-rsa-public-key/">My RSA Public Key &rarr;</a></li></ul><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname = 'bramp';

var disqus_identifier = '1614115435';


(function() {



    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><br/><footer><p class="text-muted credit">&copy; 2015. All rights reserved.</p></footer></div></div><script src=/js/jquery-1.10.2.min.js></script><script src=/js/bootstrap.min.js></script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-559846a374d7ecaa" async></script>