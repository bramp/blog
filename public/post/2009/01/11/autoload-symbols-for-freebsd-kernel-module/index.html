<!DOCTYPE html>
<html lang=en>
<head itemscope itemtype=http://schema.org/WebSite>
<meta charset=utf-8>
<meta content="width=device-width,initial-scale=1" name=viewport>
<link href=https://blog.bramp.net/post/2009/01/11/autoload-symbols-for-freebsd-kernel-module/ rel=canonical itemprop=url />
<title>Autoload symbols for FreeBSD kernel module</title>
<meta content="When debugging FreeBSD kernel modules with GDB, you have to tell GDB the correct symbols for the module, and the location the module is loaded in RAM. This is helpfully explained in the FreeBSD …" name=description itemprop=description>
<meta content="Andrew Brampton" name=author itemprop=creator>
<meta content="" name=generator />
<link href=https://blog.bramp.net/index.xml rel=alternate type=application/rss+xml title=bramp.net />
<link href=https://blog.bramp.net/index.xml rel=feed type=application/rss+xml title=bramp.net />
<link href=/favicon.ico rel="shortcut icon" type=image/x-icon />
<link href=/images/favicon.png rel=apple-touch-icon-precomposed />
<link href=/images/favicon-57x57.png rel=apple-touch-icon-precomposed sizes=57x57 />
<link href=/images/favicon-72x72.png rel=apple-touch-icon-precomposed sizes=72x72 />
<link href=/images/favicon-76x76.png rel=apple-touch-icon-precomposed sizes=76x76 />
<link href=/images/favicon-114x114.png rel=apple-touch-icon-precomposed sizes=114x114 />
<link href=/images/favicon-120x120.png rel=apple-touch-icon-precomposed sizes=120x120 />
<link href=/images/favicon-144x144.png rel=apple-touch-icon-precomposed sizes=144x144 />
<link href=/images/favicon-152x152.png rel=apple-touch-icon-precomposed sizes=152x152 />
<link href=/images/favicon-180x180.png rel=apple-touch-icon-precomposed sizes=180x180 />
<meta content=#4582EC name=msapplication-TileColor>
<meta content=/images/favicon-144x144.png name=msapplication-TileImage>
<meta content=#4582EC name=theme-color>
<link href=/images/favicon-192x192.png rel=icon sizes=192x192 />
<link href=/css/all.min.css rel=stylesheet>
<link href=https://fonts.gstatic.com rel=preconnect crossorigin>
<link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel=stylesheet type=text/css>
<link href=https://netdna.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.css rel=stylesheet>
<link href=https://cdn.jsdelivr.net/font-hack/2.010/css/hack.min.css rel=stylesheet>
<meta content=summary name=twitter:card />
<meta content=@TheBramp name=twitter:site />
<meta content=@TheBramp name=twitter:creator />
<meta content=article property=og:type />
<meta content=https://www.facebook.com/bramp property=article:author />
<meta content=2009-01-11T00:00:00&#43;07:00 property=article:published_time />
<meta content=debug property=article:tag />
<meta content=FreeBSD property=article:tag />
<meta content=gdb property=article:tag />
<meta content=kernel property=article:tag />
<meta content=python property=article:tag />
<meta content=https://blog.bramp.net/post/2009/01/11/autoload-symbols-for-freebsd-kernel-module/ property=og:url />
<meta content=bramp.net property=og:site_name />
<meta content="Autoload symbols for FreeBSD kernel module" property=og:title />
<meta content="When debugging FreeBSD kernel modules with GDB, you have to tell GDB the correct symbols for the module, and the location the module is loaded in RAM. This is helpfully explained in the FreeBSD …" property=og:description />
<meta content=2009-01-11T00:00:00&#43;00:00 property=og:updated_time />
<meta content=en_GB property=og:locale />
<meta content=RXqIC-7spNUYReoHFlubz8Fbqsg1fC1pE6FSgSnCNjQ name=google-site-verification />
</head>
<body itemscope itemtype=Blog>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-136478-5', 'auto');
    ga('require', 'linkid', 'linkid.js');
    ga('send', 'pageview');
</script>
<div id=wrapper>
<div class="navbar navbar-default">
<div class=container>
<div class=navbar-header>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse type=button>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<div class=navbar-brand aria-label="About Andrew Brampton">
<a href=/ >
<img alt=Home class=profile-image src=/images/favicon-64x64.png>
</a>
<div itemprop=author itemscope itemtype=https://schema.org/Person>
<a href=/about-me/ itemprop=name>Andrew Brampton</a>
<div id=social-wrapper>
<a href=https://twitter.com/TheBramp aria-label=Twitter><i class="fa fa-twitter-square"></i></a>
<a href=https://www.linkedin.com/in/bramp aria-label=LinkedIn><i class="fa fa-linkedin-square"></i></a>
<a href=https://www.facebook.com/bramp aria-label=Facebook><i class="fa fa-facebook-square"></i></a>
<a href=https://github.com/bramp aria-label=GitHub><i class="fa fa-github-square"></i></a>
<a href=https://feeds.feedburner.com/brampnet aria-label="RSS feed"><i class="fa fa-rss-square"></i></a>
</div>
</div>
</div>
</div>
<div class="collapse navbar-collapse">
<ul class="nav navbar-nav" role=navigation>
<li><a href=/ >Articles</a></li>
<li><a href=/about-me/ >About Me</a></li>
<li><a href=/android-app/ >Android Apps</a></li>
<li><a href=/opensource/ >Open Source</a></li>
<li><a href=/publication/ >Publications</a></li>
</ul>
</div>
</div>
</div>
<div class="container main">
<article id=article itemProp=blogPost itemscope itemtype=http://schema.org/BlogPosting>
<h1 itemprop=headline>Autoload symbols for FreeBSD kernel module</h1>
<p class=meta>
<i class="fa fa-calendar-o"></i> <time itemprop=datePublished>2009-01-11</time>
| <a href=https://blog.bramp.net/tags/debug/ >debug</a>
| <a href=https://blog.bramp.net/tags/freebsd/ >FreeBSD</a>
| <a href=https://blog.bramp.net/tags/gdb/ >gdb</a>
| <a href=https://blog.bramp.net/tags/kernel/ >kernel</a>
| <a href=https://blog.bramp.net/tags/python/ >python</a>
</p>
<div class=post itemprop=articleBody>
<p>When debugging FreeBSD kernel modules with GDB, you have to tell GDB the correct symbols for the module, and the location the module is loaded in RAM. This is helpfully explained in the <a href=http://www.freebsd.org/doc/en/books/developers-handbook/kerneldebug-kld.html>FreeBSD Developers&#8217; Handbook</a>. First you must load the module, then run kldstat, note down the address the module is loaded at, and finally execute a command in GDB that looks like the following.</p>
<pre><code>add-symbol-file /sys/modules/linux/linux.ko 0xc0ae22d0
</code></pre>
<p>However, I find this process tedious, so instead I wrote a quick python script which can be used with an <a href=http://sourceware.org/gdb/wiki/PythonGdb>experimental gdb built with python scripting support</a>.</p>
<p>So here is the script:</p>
<div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>gdb</span>
<span class=k>class</span> <span class=nc>FreeBSD_ReloadModuleSymbols</span> <span class=p>(</span><span class=n>gdb</span><span class=o>.</span><span class=n>Command</span><span class=p>):</span>
	<span class=sa></span><span class=s2>&#34;Reloads the symbol files for all loaded kernel modules&#34;</span>

	<span class=k>def</span> <span class=fm>__init__</span> <span class=p>(</span><span class=bp>self</span><span class=p>):</span>
		<span class=nb>super</span> <span class=p>(</span><span class=n>FreeBSD_ReloadModuleSymbols</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span> <span class=p>(</span><span class=sa></span><span class=s2>&#34;reload-freebsd-module-symbols&#34;</span><span class=p>,</span>
			<span class=n>gdb</span><span class=o>.</span><span class=n>COMMAND_FILES</span><span class=p>,</span>
			<span class=n>gdb</span><span class=o>.</span><span class=n>COMPLETE_NONE</span><span class=p>)</span>

	<span class=k>def</span> <span class=nf>invoke</span> <span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>arg</span><span class=p>,</span> <span class=n>from_tty</span><span class=p>):</span>
		<span class=n>link</span> <span class=o>=</span> <span class=n>gdb</span><span class=o>.</span><span class=n>parse_and_eval</span><span class=p>(</span><span class=sa></span><span class=s2>&#34;linker_files-&gt;tqh_first&#34;</span><span class=p>)</span>
		<span class=k>while</span> <span class=n>link</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
			<span class=k>print</span> <span class=n>link</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;filename&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>string</span><span class=p>()</span>
			<span class=k>if</span> <span class=n>link</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;filename&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>string</span><span class=p>()</span> <span class=o>!=</span> <span class=sa></span><span class=s2>&#34;kernel&#34;</span><span class=p>:</span>
				<span class=n>gdb</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span> <span class=sa></span><span class=s2>&#34;add-symbol-file &#34;</span> <span class=o>+</span> 
					<span class=n>link</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;pathname&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>string</span><span class=p>()</span> <span class=o>+</span> <span class=sa></span><span class=s2>&#34; &#34;</span> <span class=o>+</span>  
					<span class=nb>str</span><span class=p>(</span><span class=n>link</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;address&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>address</span><span class=p>())</span> <span class=p>)</span>
			<span class=n>link</span> <span class=o>=</span> <span class=n>link</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;link&#39;</span><span class=p>][</span><span class=sa></span><span class=s1>&#39;tqe_next&#39;</span><span class=p>]</span>

<span class=n>FreeBSD_ReloadModuleSymbols</span> <span class=p>()</span></code></pre></div>
<p>You load this by running the following command in GDB:</p>
<div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>source</span> freebsd_load_modules.py</code></pre></div>
<p>Then the command <code>reload-freebsd-module-symbols</code> is magically added to GDB. Running this command will parse the linker table inside the FreeBSD kernel, determine which modules are loaded, and attempt to load their symbols.</p>
</div>
</article>
<div class=row>
<div class=col-sm-6>
<div class=addthis_sharing_toolbox></div>
</div>
<div class=col-sm-6>
<div class=btn-toolbar>
<div class=btn-group>
<a href=https://feeds.feedburner.com/brampnet aria-label="RSS feed" class="btn btn-sm btn-soundcloud">
<i class="fa fa-rss-square"></i> Subscribe via RSS</a>
</div>
<div class=btn-group>
<a href=https://twitter.com/TheBramp class="btn btn-sm btn-twitter"><i class="fa fa-twitter"></i> Follow @TheBramp</a>
</div>
</div>
</div>
</div>
<ul class=pager>
&nbsp;<li class=previous><a href=/post/2009/01/11/linuxoffsets-for-freebsd/ >&larr; linuxoffsets for FreeBSD</a></li>
&nbsp;<li class=next><a href=/post/2009/01/21/read/write-permissions-for-php-scripts-at-lancs.ac.uk/ >Read/Write permissions for PHP scripts at lancs.ac.uk &rarr;</a></li>
</ul>
<div id=disqus_thread itemprop=comment itemscope itemtype=Comment></div>
<script type=text/javascript>
var disqus_shortname = 'bramp';
    var disqus_identifier = 'https:\/\/blog.bramp.net\/post\/2009\/01\/11\/autoload-symbols-for-freebsd-kernel-module\/';
    var disqus_title = 'Autoload symbols for FreeBSD kernel module';
    var disqus_url = 'https:\/\/blog.bramp.net\/post\/2009\/01\/11\/autoload-symbols-for-freebsd-kernel-module\/';
    (function() {
	    
	    
	    if (window.location.host.lastIndexOf(":1313") >= 0)
	        return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<br/>
<footer>
<p class="credit text-muted">&copy; 2017. All rights reserved.</p>
</footer>
</div>
</div>
<script src=/js/all.min.js></script>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-559846a374d7ecaa" async type=text/javascript></script>
</body>
</html>
