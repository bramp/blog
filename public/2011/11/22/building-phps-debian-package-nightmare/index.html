<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Building PHP’s Debian package nightmare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo"/>
  <link href="" rel="alternate" type="application/rss+xml" title="bramp.net" />
  <link href="http://bramp.net/blog/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://bramp.net/blog/css/bramp.css" rel="stylesheet">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  
  
    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-136478-5', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>

<div id = "wrapper">

  <div class="navbar navbar-default" role="navigation">
      <div class="container">

        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-brand">
            <a href="http://bramp.net/blog">
              <img src="//secure.gravatar.com/avatar/69259b422a1a9266e17977f8ec9d939e?s=64" class="profile-image" alt="Home">
            </a>
            <div>
              <a href="http://bramp.net/blog/about-me/">Andrew Brampton</a>

              <div id="social-wrapper">
              
                <a href="https://twitter.com/@TheBramp"><i class="fa fa-twitter-square"></i></a>
              
              
                <a href="https://www.linkedin.com/in/bramp"><i class="fa fa-linkedin-square"></i></a>
              
              
                <a href="https://www.facebook.com/bramp"><i class="fa fa-facebook-square"></i></a>
              
                <a href="https://github.com/bramp"><i class="fa fa-github-square"></i></a>
              
                <a href="http://bramp.net/blog/index.xml"><i class="fa fa-rss-square"></i></a>
             </div>
            </div>
          </div>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="http://bramp.net/blog/about-me/">About Me</a></li>
            <li><a href="http://bramp.net/blog/android-apps/">Android Apps</a></li>
            <li><a href="http://bramp.net/blog/posts/">Articles</a></li>
            <li><a href="http://bramp.net/blog/opensource-projects/">Open Source</a></li>
            <li><a href="http://bramp.net/blog/publications/">Publications</a></li>
          </ul>
        </div>
      </div>
    </div>

     <div class="container main">


  <div id="article">
   <h1>Building PHP’s Debian package nightmare</h1>
   <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2011-11-22</small> 410 words</p> <hr/>
   <div class="post">
     <p>I just tried to compile the Debian PHP packages, so I could make some <a href="http://www.howtoforge.com/recompiling-php5-with-bundled-support-for-gd-on-ubuntu">minor tweaks</a> to the source, to fix a bug I&#8217;m hopefully going to document shortly. This turned out to be very problematic, mainly due to the testing phase!</p>

<p>To build the Debian packages you typically do the following:</p>

<pre class="prettyprint">mkdir php
cd php
apt-get source php5
cd php5-*
debuild -us -uc -j4
</pre>

<p>While testing, the debian/setup_mysql.sh script is called, to create a temporary MySQL database. This however failed to execute correctly because I had some custom options in my [~/.my.cnf][2]. Thus it failed like so:</p>

<pre># start our own mysql server for the tests
/bin/sh debian/setup-mysql.sh 1029 /home/bramp/vendor/php/php5-5.3.8.0/mysql_db
mysqladmin: connect to server at 'localhost' failed
error: 'Access denied for user 'root'@'localhost' (using password: YES)'
make: *** [test-results.txt] Error 1
dpkg-buildpackage: error: debian/rules build gave error exit status 2
debuild: fatal error at line 1348:
dpkg-buildpackage -rfakeroot -D -us -uc -j8 failed
</pre>

<p>After removing the my.cnf things were ok. The below patch fixes it in a more general way:</p>

<pre class="prettyprint">--- debian/setup-mysql.sh.org  2011-11-21 21:57:07.244481175 -0500
+++ debian/setup-mysql.sh   2011-11-21 21:40:39.384455880 -0500
@@ -16,7 +16,7 @@
 
 socket=$datadir/mysql.sock
 # Commands:
-mysqladmin="mysqladmin -u root -P $port -h localhost --socket=$socket"
+mysqladmin="mysqladmin --no-defaults -u root -P $port -h localhost --socket=$socket"
 mysqld="/usr/sbin/mysqld --no-defaults --bind-address=localhost --port=$port --socket=$socket --datadir=$datadir"
 
 # Main code #
</pre>

<p>The next problem I encountered is that all the automated PHP unit tests were failing, and they would eventually get stuck and use all my RAM and swap space (at least 16GiB of it) <img src="http://bramp.net/blog/wp-includes/images/smilies/icon_sad.gif" alt=":(" class="wp-smiley" /> I&#8217;m not sure what made the machine run out of RAM, but the tests were failing because the version of PHP that was running the tests was incorrectly loading extensions from my system. The quick fix for this was to disable any extensions I had installed to my system. I just</p>

<pre>sudo mv /etc/php5/conf.d /etc/php5/conf.d.tmp</pre>

<p>to do that.</p>

<p>This made me think that in future I should perhaps find a cleaner environment to build these packages. In fact, it makes me wonder if the builds are just broken if my environment clearly impacts the successful run of tests.</p>

<p>One trick I found while building again and again, is that you can pass &#8220;-nc&#8221; to debuild so that it does not clean, and thus reuses the existing build materials for a faster build. Either way, I now have my own version of PHP built and installed! Next time I might just ignore the .deb files and build direct from source.</p>

<p>[2]: <a href="http://dev.mysql.com/doc/refman/5.1/en/option-files.html">http://dev.mysql.com/doc/refman/5.1/en/option-files.html</a></p>

   </div>
 </div>


 <a href="https://twitter.com/share" class="twitter-share-button " data-size="small" data-count="none">Tweet</a>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

 <ul class="pager">
      &nbsp;<li class="previous"><a href="http://bramp.net/blog/2011/11/26/php-polygon-clipper-using-the-sutherland-hodgman-algorithm/">&larr; PHP Polygon Clipper using the Sutherland-Hodgman algorithm</a></li>
      &nbsp;<li class="next"><a href="http://bramp.net/blog/2011/11/09/i-am-gnome/"> I am GNOME &rarr;</a></li>
</ul>

<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost" || window.location.port == 1313) 
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = '';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <footer>
        <p class="text-muted credit">&copy; 2015. All rights reserved. </p>
    </footer>

    </div> 
    </div> 

	
    <script src="http://bramp.net/blog/js/jquery-1.10.2.min.js"></script>
    <script src="http://bramp.net/blog/js/bootstrap.min.js"></script>
  </body>
</html>

